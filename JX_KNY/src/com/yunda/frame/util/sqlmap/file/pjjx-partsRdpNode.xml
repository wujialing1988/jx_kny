<!-- 流水线-工位使用质量技术单查询，Sql语句映射，第一行不能是注释否则会解析错误  -->
<SqlMap>
	<!-- 配件检修任务处理 - 查询 -->
	<sql id="selectAll">
		<![CDATA[
		SELECT T.*,
      NVL(D.BACK_COUNTS,0) AS "BACK_COUNTS",
      (
      NVL(A.TASK_COUNTS_A,0) + NVL(B.TASK_COUNTS_B,0) + NVL(C.TASK_COUNTS_C,0)
      ) AS "TASK_COUNTS",
      E.WORK_STATION_NAME,
      E.WORK_STATION_IDX
    FROM (
      SELECT A.IDX,
           B.PARTS_ACCOUNT_IDX,
           B.IDENTIFICATION_CODE,
           B.SPECIFICATION_MODEL,
           B.PARTS_NAME,
           B.PARTS_NO,
           B.UNLOAD_TRAINTYPE,
           B.UNLOAD_TRAINNO,
           B.UNLOAD_REPAIR_CLASS,
           B.UNLOAD_REPAIR_TIME,
           B.REPAIR_ORGNAME,
           A.RDP_IDX,
           A.WP_NODE_NAME,
           TO_CHAR(A.PLAN_STARTTIME, 'YYYY-MM-DD HH24:MI:SS') AS "PLAN_STARTTIME",
           TO_CHAR(A.PLAN_ENDTIME, 'YYYY-MM-DD HH24:MI:SS') AS "PLAN_ENDTIME",
           TO_CHAR(A.REAL_STARTTIME, 'YYYY-MM-DD HH24:MI:SS') AS "REAL_STARTTIME",
           TO_CHAR(A.REAL_ENDTIME, 'YYYY-MM-DD HH24:MI:SS') AS "REAL_ENDTIME",
           A.STATUS,
           A.SEQ_NO,
         P.UNLOAD_PLACE
      FROM 
          PJJX_PARTS_RDP_NODE A
      INNER JOIN 
          PJJX_PARTS_RDP B ON A.RDP_IDX = B.IDX AND B.STATUS IN ('02','03','0401')
        INNER JOIN 
            PJWZ_PARTS_ACCOUNT P ON P.IDX = B.PARTS_ACCOUNT_IDX
      WHERE 
         A.RECORD_STATUS = 0
         AND B.RECORD_STATUS = 0
         AND A.IS_LEAF = '1'
       ) T 
       LEFT JOIN 
       (SELECT RDP_NODE_IDX, COUNT(*) AS "BACK_COUNTS" FROM PJJX_PARTS_RDP_RECORD_CARD WHERE RECORD_STATUS=0 AND IS_BACK = '1' GROUP BY RDP_NODE_IDX ) D ON D.RDP_NODE_IDX = T.IDX
       LEFT JOIN
       (SELECT A.RDP_NODE_IDX, COUNT(*) AS "TASK_COUNTS_A" FROM PJJX_PARTS_RDP_RECORD_CARD A WHERE A.RECORD_STATUS='0' AND A.STATUS IN ('01', '02', '03') GROUP BY A.RDP_NODE_IDX) A ON  A.RDP_NODE_IDX = T.IDX
       LEFT JOIN
       (SELECT B.RDP_NODE_IDX, COUNT(*) AS "TASK_COUNTS_B" FROM PJJX_PARTS_RDP_TEC_CARD B WHERE B.RECORD_STATUS='0' AND B.STATUS IN ('01', '02', '03') GROUP BY B.RDP_NODE_IDX) B ON B.RDP_NODE_IDX = T.IDX
       LEFT JOIN
       (SELECT C.RDP_NODE_IDX, COUNT(*) AS "TASK_COUNTS_C" FROM PJJX_PARTS_RDP_NOTICE C WHERE C.RECORD_STATUS='0' AND C.STATUS IN ('01', '02', '03') GROUP BY C.RDP_NODE_IDX ) C ON C.RDP_NODE_IDX = T.IDX
       LEFT JOIN
       (SELECT E.RDP_NODE_IDX, 
               to_char(wm_concat(E.WORK_STATION_NAME)) AS "WORK_STATION_NAME",
               to_char(wm_concat(E.WORK_STATION_IDX)) AS "WORK_STATION_IDX" 
        FROM PJJX_PARTS_RDP_NODE_STATION E WHERE E.RECORD_STATUS = 0 GROUP BY E.RDP_NODE_IDX) E ON E.RDP_NODE_IDX = T.IDX
       ORDER BY T.REAL_ENDTIME DESC 
		]]>
	</sql>
</SqlMap>
